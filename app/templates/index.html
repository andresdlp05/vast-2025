{% extends "base.html" %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold mb-6"> MC3 Data Visualization</h1>

    <!-- Tab navigation -->
    <ul class="nav nav-tabs mb-4 flex flex-wrap border-b border-gray-200" id="visualizationTabs" role="tablist">
        {% for viz in visualizations %}
        <li class="nav-item mr-2" role="presentation">
            <button
                class="nav-link {% if loop.first %}active{% endif %} py-2 px-4 block font-medium text-sm rounded-t-lg border-b-2"
                id="tab-{{ viz.name }}" data-bs-toggle="tab" data-bs-target="#{{ viz.name }}" type="button" role="tab"
                aria-controls="{{ viz.name }}" aria-selected="{{ 'true' if loop.first else 'false' }}"
                data-viz-name="{{ viz.name }}">
                {{ viz.title }}
            </button>
        </li>
        {% endfor %}
    </ul>

    <!-- Tab content -->
    <div class="tab-content" id="visualizationContent">
        {% for viz in visualizations %}
        <div class="tab-pane fade {% if loop.first %}show active{% endif %}" id="{{ viz.name }}" role="tabpanel"
            aria-labelledby="tab-{{ viz.name }}">
            <div class="bg-white rounded-lg shadow-md p-4 mb-4">
                <p class="text-gray-700 mb-4">{{ viz.description }}</p>
                {% include viz.name + '.html' %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Bootstrap for tabs -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- Visualization-specific CSS -->
{% for viz in visualizations %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/' + viz.name + '.css') }}">
{% endfor %}

<!-- Visualization-specific JS -->
{% for viz in visualizations %}
<script src="{{ url_for('static', filename='js/' + viz.name + '.js') }}"></script>
{% endfor %}

<!-- Central initialization script -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const tabButtons = document.querySelectorAll('[data-bs-toggle="tab"]');

        // Initialize the active tab on page load
        const activeTab = document.querySelector('.nav-link.active');
        if (activeTab) {
            const vizName = activeTab.dataset.vizName;
            initializeVisualization(vizName);
        }

        // Add event listener for tab changes
        tabButtons.forEach(tab => {
            tab.addEventListener('shown.bs.tab', function (event) {
                const vizName = event.target.dataset.vizName;
                initializeVisualization(vizName);
            });
        });

        // Initialize visualization function
        function initializeVisualization(vizName) {
            console.log(`Initializing visualization: ${vizName}`);
            const initFunction = window[`init_${vizName}`];

            if (typeof initFunction === 'function') {
                try {
                    initFunction();
                } catch (error) {
                    console.error(`Error initializing ${vizName}:`, error);
                }
            } else {
                console.warn(`Initialization function not found for visualization: ${vizName}`);
            }
        }
    });
</script>
{% endblock %}